#! /bin/sh

# mkfstab  - make new fstab for freshly installed arch system

#
# Author: Michael Towers (gradgrind) <mt.42@web.de>
#
# This file is part of the larch project.
#
#    larch is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    larch is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with larch; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
#
#----------------------------------------------------------------------------
#

# Note that the results are not copied into place
# They end up here:
DEST=${TEMPDIR}/fstab
MNT=${TEMPDIR}/mnt

if [ -n "$( df | grep " ${MNT}" )" ]; then
    echo "ERROR: Mounted filesystem at/within ${MNT}" | tee -a ${LOGFILE}
    exit 1
fi
mkdir -p ${MNT}
rm -rf ${MNT}/*

tmpfile=${TEMPDIR}/fstab2
: >${tmpfile}

echo "# fstab generated by mkfstab" >${DEST}
echo "#<partition> <dir>        <type>   <options>    <dump> <pass>" >>${DEST}
echo >>${DEST}

# System partitions
cat ${TEMPDIR}/mounts | tr '!' ' ' | { while read mp dev fst fstx; do
        if [ ${mp} = "/" ]; then pass=1; else pass=2; fi
        if [ "${fst}" = "-" ]; then
            fst="$( blkid -o value -s TYPE ${dev} )"
        fi
        printf "%-12s %-12s %-8s defaults,noatime 0     ${pass}\n" \
                ${dev} ${mp} ${fst} >>${DEST}
    done }
echo >>${DEST}
echo "none         /dev/pts     devpts   defaults           0     0" >>${DEST}
echo "none         /dev/shm     tmpfs    defaults           0     0" >>${DEST}
echo >>${DEST}

# Get all other partitions
sfdisk -d | grep "^/dev/" | sed "s|\(.*\):.*Id=\(..\).*|\1 \2|" | \
    while read dev id; do
        # Ignore if id is "Extended" or "LVM", these are not usable partitions
        if [ "${id}" = "5" -o "${id}" = "8e" ]; then continue; fi
        # Skip if it is one of the system partitions
        if [ -n "$( grep "!${dev}!" ${TEMPDIR}/mounts )" ]; then continue; fi
        # See if swap
        if [ "${id}" = "82" ]; then
            printf "%-12s %-12s %-8s defaults,noatime 0     0\n" \
                ${dev} swap swap >>${DEST}
            continue
        fi
        removable=""
        part=$( basename ${dev} )
        if [ $( cat /sys/block/${part:0:3}/removable 2>/dev/null ) -ne 0 ]; then
            removable="_rmv"
        fi
        mountdir=${part}${removable}
        printf "%-12s %-12s %-8s user,noauto,noatime 0     0\n" \
                ${dev} /mnt/${mountdir} auto >>${tmpfile}
        mkdir -p ${MNT}/${mountdir}
    done

# LVM
for lvmd in $( ls /dev/mapper 2>/dev/null | grep -v control ); do
    printf "%-30s %-22s %-8s user,noauto,noatime 0     0\n" \
           /dev/mapper/${lvmd} /mnt/${lvmd} auto >>${tmpfile}
    mkdir -p ${MNT}/${lvmd}
done

echo >>${DEST}
cat ${tmpfile} >>${DEST}
rm ${tmpfile}
echo >>${DEST}

# CD devices
for dev in $( cat /proc/sys/dev/cdrom/info 2>/dev/null | head -n 3 | \
        tail -n 1 | cut -d ":" -f 2 ); do
    mountdir="${dev}_cd"
    mkdir ${MNT}/${mountdir}
    printf "%-12s %-12s %-8s user,noauto,exec,unhide 0     0\n" \
            /dev/${dev} /mnt/${mountdir} auto >>${DEST}
done

echo >>${DEST}
echo "# This would do for a floppy" >>${DEST}
echo "#/dev/fd0     /mnt/floppy    vfat,ext2 rw,user,noauto    0     0" >>${DEST}
echo "#    +   mkdir /mnt/floppy" >>${DEST}
echo >>${DEST}
echo "# E.g. for USB storage:" >>${DEST}
echo "#/dev/sda1    /mnt/usb       auto      rw,user,noauto    0     0" >>${DEST}
echo "#    +   mkdir /mnt/usb" >>${DEST}
